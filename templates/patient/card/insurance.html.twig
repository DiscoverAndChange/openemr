{% extends "patient/card/card_base.html.twig" %}

{% block content %}
<ul class="nav nav-tabs mb-2 insurance-nav-tabs">
{% for t,data in ins %}
    {% set tFirst = loop.first %}
    {% for policy in data.policies %}
    <li class="nav-item {% if policy.id != data.current.id %} d-none{% endif %}" role="presentation">
        <a data-type="{{ t|attr }}" href="#{{ t|attr }}-{{ policy.id|attr }}" id="{{ t|attr }}-{{ policy.id|attr }}-tab" data-toggle="tab" role="tab" aria-controls="{{ t|attr }}-{{ policy.id|attr }}" aria-selected="{{ loop.first ? "true" : "false" }}" class="nav-link {{ tFirst ? "active" }}">
            {{ t|capitalize|text }}
        </a>
    </li>
    {% endfor %}
{% endfor %}
    <li class="nav-item" role="presentation">
        <a id='eligibility-tab' class="nav-link" href='#eligibility' data-toggle="tab" aria-controls="eligibility" role="tab" aria-selected="false">{{ "Eligibility"|xlt }}</a>
    </li>
</ul>
<div class="tab-content px-1">
{% for t,data in ins %}
    {% set tFirst = loop.first %}
    <select class="form-control mb-2 {% if not loop.first %}d-none{% endif %} insurance-policy-select" id="insurance-policy-select-{{ t }}">
        {% for c in data.policies %}
            <option value="{{ c.type|attr }}-{{ c.id|attr }}" {{ loop.first ? "selected" : "" }}>
                {{ c.insco.display_name|capitalize|text }}
                {% if c.dispFromDate == true %}{{ "from"|xlt}} {{ c.date|shortDate|text }} {% endif %}
                {{ "until"|xlt }} {{ (c.date_end) ? c.date_end|text : "Present"|xlt }}
            </option>
        {% endfor %}
    </select>
    {% for c in data.policies %}
    <div class="tab-pane {{ tFirst and loop.first ? "active" }}" id="{{ c.type|attr }}-{{ c.id|attr }}" role="tabpanel" aria-labelledby="{{ c.type|attr }}-{{ c.id|attr }}-tab">
        <div class="text-primary pb-2 pt-1">
            {{ c.type|capitalize|text }} {{ "Insurance"|xlt }}
            {% if c.dispFromDate == true %}{{ "from"|xlt}} {{ c.date|shortDate|text }} {% endif %}
            {{ "until"|xlt }} {{ (c.date_end) ? c.date_end|text : "Present"|xlt }}
        </div>
        <div class="d-flex justify-content-between">
            <div class="insurer">
                {% if c.insco is defined %}
                    <em>{{ "Insurer"|xlt }}</em>
                    <address>
                        <strong>{{ c.insco.name|text }}</strong><br>
                        {{ c.insco.address.line1|text }}<br>
                        {{ (c.insco.address.line2 != "") ? c.insco.address.line2|text ~ "<br>"|raw }}
                        {{ c.insco.address.city|text }} {{ c.insco.address.state|text }}, {{ c.insco.address.postal|text }}
                    </address>
                {% else %}
                    <span class="font-weight-bold text-danger">{{ "Unassigned"|xlt }}</span>
                {% endif %}
            </div>
            <div class="subscriber">
                {% set showState = (c.subscriber_state != "") ? true : false %}
                {% set showCountry = (c.subscriber_country != "") ? true : false %}
                {% set showPostal = (c.subscriber_postal_code != "") ? true : false %}
                <em>{{ "Subscriber"|xlt }}</em>
                <address class="mb-1">
                    <strong>{{ c.subscriber_full_name|text }}{{ c.subscriber_relationship != "" ? " (" ~ c.subscriber_relationship|capitalize|text ~ ")" : "" }}</strong><br>
                    {{ c.subscriber_street|text }}<br>
                    {{ c.subscriber_city|text }}{{ showState == true ? " " ~ c.subscriber_state|text : ""}}{{ showPostal == true ? ", " ~ c.subscriber_postal_code|text : "" }}
                    {{ showCountry == true ? " " ~ c.subscriber_country|text : ""}}
                </address>
                {% if c.subscriber_ss != "" %}
                <strong>{{ "S.S."|xlt }}</strong>
                <span class="">{{ c.subscriber_ss|text }}</span><br>
                {% endif %}
                {% if c.subscriber_DOB %}
                <strong>{{ "D.O.B."|xlt }}</strong>
                <span class="">{{ c.subscriber_DOB|shortDate|text }}</span><br>
                {% endif %}
                {% if c.subscriber_phone %}
                <strong>{{ "Phone"|xlt }}</strong>
                <span class="">{{ c.subscriber_phone|text }}</span><br>
                {% endif %}
            </div>
            <div class="subscriber-employer">
                {% set showState = (c.subscriber_employer_state != "") ? true : false %}
                {% set showCountry = (c.subscriber_employer_country != "") ? true : false %}
                {% set showPostal = (c.subscriber_employer_postal_code != "") ? true : false %}
                <em>{{ "Subscriber Employer"|xlt }}</em>
                <address class="mb-1">
                    <strong>{{ c.subscriber_employer|text }}</strong><br>
                    {{ c.subscriber_employer_street|text }}<br>
                    {{ c.subscriber_employer_city|text }}{{ showState == true ? " " ~ c.subscriber_employer_state|text : ""}}{{ showPostal == true ? ", " ~ c.subscriber_employer_postal_code|text : "" }}
                    {{ showCountry == true ? " " ~ c.subscriber_employer_country|text : ""}}
                </address>
            </div>
        </div>
        <div class="d-flex justify-content-between policy-details pt-2">
            <div class="list-group list-group-flush flex-fill mr-4">
                <div class="list-group-item d-flex justify-content-between p-1"><strong>{{ "Plan Name"|xlt }}:</strong> <span class="text-right">{{ c.plan_name|text }}</span></div>
                <div class="list-group-item d-flex justify-content-between p-1"><strong>{{ "Policy Number"|xlt }}:</strong> <span class="text-right text-monospace">{{ c.policy_number|text }}</span></div>
                <div class="list-group-item d-flex justify-content-between p-1"><strong>{{ "Group Number"|xlt }}:</strong> <span class="text-right text-monospace">{{ c.group_number|text }}</span></div>
            </div>
            <div class="list-group list-group-flush flex-fill">
                <div class="list-group-item d-flex justify-content-between p-1"><strong>{{ "Copay"|xlt }}:</strong> <span class="text-right">{{ c.copay|text }}</span></div>
                <div class="list-group-item d-flex justify-content-between p-1"><strong>{{ "Accepts Assignment"|xlt }}:</strong> <span class="text-right">{{ c.accept_assignment == 'TRUE' ? "Yes"|xlt : "No"|xlt }}</span></div>
                {% if c.policy_type %}
                <div class="list-group-item d-flex justify-content-between p-1"><strong class="flex-fill">{{ "Secondary Medicare Type"|xlt }}:</strong> <span class="text-right flex-fill">{{ c.policy_type|text }}</span></div>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
{% endfor %}
    <div class="tab-pane" id="eligibility" role="tabpanel" aria-labelledby="eligibility-tab">
        {% if enable_eligibility_requests %}
        <form action="./demographics.php" method="post">
            <div>
                <button class='btn btn-success btn-sm btn-transmit float-right' name='status_update' value='true'>{{ "Update Status"|xlt }}</button>
            </div>
            {{ eligibility }}
        </form>
        {% else %}
            {{ eligibility }}
        {% endif %}
    </div>
    <script>
        function showTab(tabNavItem) {
            if (!tabNavItem) {
                console.error('No tab instance found for ', tabNavItem);
                return;
            }
            // let tab = bootstrap.Tab.getInstance(tabNavItem);
            // tab.show(); // bootstrap 5
            let $tab = $(tabNavItem);
            if (!$tab.length) {
                console.error('No tab instance found for ', tabNavItem);
                return;
            }
            $tab.tab('show'); // bootstrap 4.6
            let tabId = tabNavItem.getAttribute('aria-controls');
            let tabPane = document.getElementById(tabId);
            if (!tabPane) {
                console.error('No tab pane found for ', e.target);
                return;
            }
            let type = tabNavItem.dataset['type'] || 'primary';
            showPolicySelectDropdown(type);
        }
        function showPolicySelectDropdown(tabNavItem) {
            let tabId = tabNavItem.getAttribute('aria-controls');
            let type = tabNavItem.dataset['type'] || 'primary';
            let selectLists = document.querySelectorAll('.insurance-policy-select');
            selectLists.forEach(select => {
                select.classList.add('d-none');
            });

            let select = document.getElementById(`insurance-policy-select-${type}`);
            if (!select) {
                console.error('No select found for ', e.target);
                return;
            }
            let tabPane = document.getElementById(tabId);
            if (!tabPane) {
                console.error('No tab pane found for ', e.target);
                return;
            }
            select.value = tabId;
            select.classList.remove('d-none');
            if (tabPane.firstChild != select) {
                tabPane.insertBefore(select, tabPane.firstChild);
                return;
            }
        }

        let types = {{ types|json_encode }};

        // have to be in jQuery land in order to get the event
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            let tabId = e.target.getAttribute('aria-controls');
            showPolicySelectDropdown(e.target);
        });
        types.forEach(t => {
            let select = document.getElementById(`insurance-policy-select-${t}`);
            if (select) {
                select.addEventListener('change', e => {
                    let tabId = e.target.value;
                    let tabNavItem = document.getElementById(tabId + "-tab");
                    if (!tabNavItem) {
                        console.error('No tab found for ', e.target);
                        return;
                    }
                    showTab(tabNavItem);
                });
            }
        })
    </script>
</div>
{% endblock %}
